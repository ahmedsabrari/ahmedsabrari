name: Update cached GitHub cards
on:
  schedule:
    - cron: '0 0 * * *' # daily at 00:00 UTC
  workflow_dispatch: {}

jobs:
  update-cards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Fetch and validate SVG cards
        run: |
          set -euo pipefail

          mkdir -p images/stats images/repos

          declare -a urls=(
            "https://github-readme-stats.vercel.app/api?username=ahmedsabrari&theme=radical&show_icons=true&hide_border=false&count_private=false&include_all_commits=false::images/stats/overview.svg"
            "https://nirzak-streak-stats.vercel.app/?user=ahmedsabrari&theme=radical&hide_border=false::images/stats/streak.svg"
            "https://github-readme-stats.vercel.app/api/top-langs/?username=ahmedsabrari&theme=radical&hide_border=false&count_private=true&exclude_repo=profile-summary-for-github,E-commerce&layout=compact::images/stats/top-langs.svg"
            "https://github-contributor-stats.vercel.app/api?username=ahmedsabrari&limit=5&theme=radical&combine_all_yearly_contributions=true::images/stats/contributors.svg"
            "https://github-readme-stats.vercel.app/api/pin/?username=ahmedsabrari&repo=E-commerce&show_owner=true&theme=radical::images/repos/ecommerce_pin.svg"
            "https://github-readme-stats.vercel.app/api/pin/?username=ahmedsabrari&repo=hello_world_gui&show_owner=true&theme=radical::images/repos/hello_world_pin.svg"
            "https://github-readme-stats.vercel.app/api/pin/?username=ahmedsabrari&repo=heart-drawing&show_owner=true&theme=radical::images/repos/heart_pin.svg"
            "https://github-readme-stats.vercel.app/api/pin/?username=ahmedsabrari&repo=image-to-pencil-sketch&show_owner=true&theme=radical::images/repos/pencil_sketch_pin.svg"
          )

          changed=0
          tmpdir=$(mktemp -d)

          for entry in "${urls[@]}"; do
            url=${entry%%::*}
            out=${entry##*::}
            tmpfile="$tmpdir/$(basename "$out").tmp"

            echo "Fetching: $url -> $out"

            if ! curl -fsSL "$url" -o "$tmpfile"; then
              echo "  Warning: could not fetch $url; skipping"
              rm -f "$tmpfile"
              continue
            fi

            if ! grep -qi "<svg" "$tmpfile"; then
              echo "  Warning: downloaded content for $url does not appear to be SVG; skipping"
              rm -f "$tmpfile"
              continue
            fi

            mkdir -p "$(dirname "$out")"

            if [ -f "$out" ]; then
              if cmp -s "$tmpfile" "$out"; then
                echo "  No change for $out"
                rm -f "$tmpfile"
                continue
              fi
            fi

            mv "$tmpfile" "$out"
            echo "  Updated $out"
            changed=1
          done

          rm -rf "$tmpdir"

          if [ "$changed" -eq 0 ]; then
            echo "No SVGs changed; exiting without commit"
            exit 0
          fi

      - name: Commit & push updates
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add images/stats images/repos || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "ci: update cached GitHub stat cards"
          git push origin HEAD:main
