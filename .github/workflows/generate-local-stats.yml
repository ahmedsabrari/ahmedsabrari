name: Generate Local GitHub Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Dependencies
      run: |
        mkdir -p scripts
        cd scripts
        cat > package.json << 'EOF'
        {
          "name": "github-stats-generator",
          "version": "1.0.0",
          "dependencies": {
            "@octokit/rest": "^20.0.2"
          }
        }
        EOF
        npm install --no-package-lock
    
    - name: Fetch Real GitHub Data with AHMEDSTATUS Token
      env:
        MY_GITHUB_TOKEN: ${{ secrets.AHMEDSTATUS }}
      run: |
        cd scripts
        node -e "
          const { Octokit } = require('@octokit/rest');
          const fs = require('fs');
          const path = require('path');
          
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… AHMEDSTATUS Token
          const octokit = new Octokit({ 
            auth: process.env.MY_GITHUB_TOKEN,
            userAgent: 'ahmedsabrari-stats v1.0'
          });
          
          const username = 'ahmedsabrari';
          
          console.log('ğŸš€ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† GitHub API...');
          
          async function getAllRepos() {
            let allRepos = [];
            let page = 1;
            
            try {
              while (true) {
                const { data } = await octokit.repos.listForUser({
                  username: username,
                  per_page: 100,
                  page: page,
                  sort: 'updated',
                  direction: 'desc'
                });
                
                if (data.length === 0) break;
                
                allRepos = allRepos.concat(data);
                page++;
                
                if (data.length < 100) break;
              }
            } catch (error) {
              console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª:', error.message);
            }
            
            return allRepos;
          }
          
          async function main() {
            try {
              // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
              const { data: user } = await octokit.users.getByUsername({
                username: username
              });
              
              console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.login);
              
              // 2. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
              const repos = await getAllRepos();
              console.log('âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª:', repos.length);
              
              // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              const totals = {
                stars: repos.reduce((sum, repo) => sum + repo.stargazers_count, 0),
                forks: repos.reduce((sum, repo) => sum + repo.forks_count, 0),
                watchers: repos.reduce((sum, repo) => sum + repo.watchers_count, 0)
              };
              
              // 4. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
              const languages = {};
              repos.forEach(repo => {
                if (repo.language) {
                  languages[repo.language] = (languages[repo.language] || 0) + 1;
                }
              });
              
              // 5. ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¬ÙˆÙ…
              const popularRepos = repos
                .filter(repo => !repo.fork)
                .sort((a, b) => b.stargazers_count - a.stargazers_count)
                .slice(0, 10);
              
              // 6. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              const statsData = {
                user: {
                  name: user.name || user.login,
                  login: user.login,
                  public_repos: user.public_repos,
                  followers: user.followers,
                  following: user.following,
                  created_at: user.created_at,
                  avatar_url: user.avatar_url
                },
                totals,
                languages,
                popularRepos: popularRepos.map(repo => ({
                  name: repo.name,
                  full_name: repo.full_name,
                  description: repo.description,
                  stargazers_count: repo.stargazers_count,
                  forks_count: repo.forks_count,
                  watchers_count: repo.watchers_count,
                  language: repo.language,
                  html_url: repo.html_url,
                  updated_at: repo.updated_at
                })),
                generated_at: new Date().toISOString()
              };
              
              // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ data
              const dataDir = path.join(__dirname, '../data');
              if (!fs.existsSync(dataDir)) {
                fs.mkdirSync(dataDir, { recursive: true });
              }
              
              // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù JSON
              fs.writeFileSync(
                path.join(dataDir, 'github-stats.json'),
                JSON.stringify(statsData, null, 2)
              );
              
              console.log('ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:');
              console.log('- Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª:', statsData.user.public_repos);
              console.log('- Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙˆÙ†:', statsData.user.followers);
              console.log('- Ø§Ù„Ù†Ø¬ÙˆÙ…:', statsData.totals.stars);
              console.log('- Ø§Ù„Ù„ØºØ§Øª:', Object.keys(statsData.languages).length);
              
            } catch (error) {
              console.error('âŒ Ø®Ø·Ø£ Ø±Ø¦ÙŠØ³ÙŠ:', error.message);
              
              // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
              const fallbackData = {
                user: {
                  name: 'ahmedsabrari',
                  login: 'ahmedsabrari',
                  public_repos: 8,
                  followers: 0,
                  following: 0,
                  created_at: '',
                  avatar_url: ''
                },
                totals: { stars: 14, forks: 4, watchers: 0 },
                languages: { JavaScript: 2, Python: 4, PHP: 1, HTML: 1 },
                generated_at: new Date().toISOString()
              };
              
              const dataDir = path.join(__dirname, '../data');
              if (!fs.existsSync(dataDir)) {
                fs.mkdirSync(dataDir, { recursive: true });
              }
              
              fs.writeFileSync(
                path.join(dataDir, 'github-stats.json'),
                JSON.stringify(fallbackData, null, 2)
              );
            }
          }
          
          main();
        "
    
    - name: Generate SVG Files from Real Data
      run: |
        python3 << 'EOF'
        import json
        import os
        from datetime import datetime
        import math
        
        # Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ…
        THEME = {
            'bg': '#0D1117',
            'primary': '#FF6B6B',
            'secondary': '#58A6FF',
            'text': '#C9D1D9',
            'muted': '#8B949E',
            'border': '#30363D'
        }
        
        def load_data():
            """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON"""
            try:
                with open('data/github-stats.json', 'r') as f:
                    return json.load(f)
            except:
                return None
        
        def create_overview_svg(data):
            """Ø¥Ù†Ø´Ø§Ø¡ SVG Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©"""
            if data:
                user = data.get('user', {})
                totals = data.get('totals', {})
                
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">GitHub Stats</text>
                
                <text x="30" y="75" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Public Repos:</text>
                <text x="180" y="75" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['secondary']}" font-weight="bold">{user.get('public_repos', 0)}</text>
                
                <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Followers:</text>
                <text x="180" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['secondary']}" font-weight="bold">{user.get('followers', 0)}</text>
                
                <text x="30" y="125" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Following:</text>
                <text x="180" y="125" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['secondary']}" font-weight="bold">{user.get('following', 0)}</text>
                
                <text x="30" y="150" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Total Stars:</text>
                <text x="180" y="150" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['secondary']}" font-weight="bold">{totals.get('stars', 0)}</text>
                
                <text x="250" y="185" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="{THEME['muted']}">@{user.get('login', 'ahmedsabrari')}</text>
                </svg>'''
            else:
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">GitHub Stats</text>
                <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</text>
                </svg>'''
            
            return svg
        
        def create_top_langs_svg(data):
            """Ø¥Ù†Ø´Ø§Ø¡ SVG Ù„Ù„ØºØ§Øª Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹"""
            if data and data.get('languages'):
                languages = data['languages']
                sorted_langs = sorted(languages.items(), key=lambda x: x[1], reverse=True)[:8]
                total = sum(languages.values())
                
                svg_lines = []
                y = 75
                for i, (lang, count) in enumerate(sorted_langs):
                    percentage = (count / total * 100) if total > 0 else 0
                    bar_width = percentage * 2
                    
                    svg_lines.append(f'''
                    <text x="30" y="{y}" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">{lang}</text>
                    <rect x="150" y="{y-12}" width="200" height="15" fill="{THEME['border']}" rx="5" ry="5"/>
                    <rect x="150" y="{y-12}" width="{bar_width}" height="15" fill="{THEME['secondary']}" rx="5" ry="5"/>
                    <text x="360" y="{y}" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="{THEME['muted']}">{percentage:.1f}%</text>
                    ''')
                    y += 25
                
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">Top Languages</text>
                {''.join(svg_lines)}
                </svg>'''
            else:
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">Top Languages</text>
                <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„ØºØ§Øª...</text>
                </svg>'''
            
            return svg
        
        def create_streak_svg():
            """Ø¥Ù†Ø´Ø§Ø¡ SVG Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø§Øª"""
            svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
            <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
            <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">Contribution Streak</text>
            <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Self-hosted Stats</text>
            <text x="30" y="130" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="{THEME['muted']}">Updated: {datetime.now().strftime('%Y-%m-%d %H:%M')}</text>
            </svg>'''
            return svg
        
        def create_contributors_svg(data):
            """Ø¥Ù†Ø´Ø§Ø¡ SVG Ù„Ù„Ù…Ø³Ø§Ù‡Ù…ÙŠÙ†"""
            if data:
                user = data.get('user', {})
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">Contributor Stats</text>
                <text x="30" y="85" font-family="Segoe UI, Arial, sans-serif" font-size="18" fill="{THEME['secondary']}" font-weight="bold">{user.get('name', user.get('login', 'ahmedsabrari'))}</text>
                <text x="30" y="115" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="{THEME['text']}">Primary contributor</text>
                <text x="30" y="145" font-family="Segoe UI, Arial, sans-serif" font-size="12" fill="{THEME['muted']}">@{user.get('login', 'ahmedsabrari')}</text>
                </svg>'''
            else:
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="{THEME['primary']}" font-weight="bold">Contributor Stats</text>
                <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="{THEME['text']}">Loading data...</text>
                </svg>'''
            
            return svg
        
        def create_repo_svg(repo_name, repo_data=None):
            """Ø¥Ù†Ø´Ø§Ø¡ SVG Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹"""
            if repo_data:
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="320" height="150" viewBox="0 0 320 150">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="20" fill="{THEME['primary']}" font-weight="bold">{repo_name[:20]}{'...' if len(repo_name) > 20 else ''}</text>
                <text x="20" y="70" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="{THEME['text']}">â­ {repo_data.get('stargazers_count', 0)}</text>
                <text x="80" y="70" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="{THEME['text']}">ğŸ´ {repo_data.get('forks_count', 0)}</text>
                <text x="20" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="12" fill="{THEME['secondary']}">Language: {repo_data.get('language', 'N/A')}</text>
                <text x="20" y="125" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="{THEME['muted']}">Updated: {datetime.now().strftime('%Y-%m-%d')}</text>
                </svg>'''
            else:
                svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="320" height="150" viewBox="0 0 320 150">
                <rect width="100%" height="100%" fill="{THEME['bg']}" rx="10" ry="10"/>
                <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="20" fill="{THEME['primary']}" font-weight="bold">{repo_name}</text>
                <text x="20" y="80" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="{THEME['text']}">Real-time data</text>
                <text x="20" y="110" font-family="Segoe UI, Arial, sans-serif" font-size="12" fill="{THEME['muted']}">Powered by GitHub API</text>
                </svg>'''
            
            return svg
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        data = load_data()
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
        os.makedirs('public/stats', exist_ok=True)
        os.makedirs('public/repos', exist_ok=True)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª SVG
        with open('public/stats/overview.svg', 'w') as f:
            f.write(create_overview_svg(data))
        
        with open('public/stats/top-langs.svg', 'w') as f:
            f.write(create_top_langs_svg(data))
        
        with open('public/stats/streak.svg', 'w') as f:
            f.write(create_streak_svg())
        
        with open('public/stats/contributors.svg', 'w') as f:
            f.write(create_contributors_svg(data))
        
        # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©
        featured_repos = [
            ('E-commerce', {}),
            ('hello_world_gui', {}),
            ('heart-drawing', {}),
            ('image-to-pencil-sketch', {})
        ]
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        if data and data.get('popularRepos'):
            repo_data_map = {}
            for repo in data['popularRepos']:
                repo_data_map[repo['name']] = repo
            
            for i, (repo_name, _) in enumerate(featured_repos):
                if repo_name in repo_data_map:
                    featured_repos[i] = (repo_name, repo_data_map[repo_name])
        
        # Ø¥Ù†Ø´Ø§Ø¡ SVG Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
        for repo_name, repo_data in featured_repos:
            safe_name = repo_name.replace('-', '_').lower()
            with open(f'public/repos/{safe_name}_pin.svg', 'w') as f:
                f.write(create_repo_svg(repo_name, repo_data))
        
        print('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª SVG Ø¨Ù†Ø¬Ø§Ø­!')
        EOF
    
    - name: Commit and Push Real Stats
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        git add public/
        
        # Ø¥Ø¶Ø§ÙØ© data/ Ø¥Ù„Ù‰ .gitignore Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if ! grep -q "^data/$" .gitignore; then
          echo "data/" >> .gitignore
        fi
        
        # Ø¥Ø¶Ø§ÙØ© node_modules/ Ø¥Ù„Ù‰ .gitignore
        if ! grep -q "^node_modules/$" .gitignore; then
          echo "node_modules/" >> .gitignore
        fi
        
        git add .gitignore
        
        # Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
        if [[ -n $(git status --porcelain public/) ]]; then
          git commit -m "ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!"
        else
          echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©"
        fi