name: Generate Local GitHub Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Create package.json in scripts directory
      run: |
        cd scripts
        cat > package.json << 'EOF'
        {
          "name": "github-stats-generator",
          "version": "1.0.0",
          "description": "Local GitHub stats generator",
          "main": "github-stats.js",
          "dependencies": {
            "@octokit/rest": "^20.0.2"
          },
          "scripts": {
            "start": "node github-stats.js"
          }
        }
        EOF
    
    - name: Install Node.js Dependencies
      working-directory: ./scripts
      run: |
        npm install
    
    - name: Create Data Directory
      run: |
        mkdir -p data
    
    - name: Fetch GitHub Data
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      working-directory: ./scripts
      run: |
        node -e "
          const { Octokit } = require('@octokit/rest');
          const fs = require('fs');
          const path = require('path');
          
          const octokit = new Octokit({ 
            auth: process.env.GITHUB_TOKEN,
            userAgent: 'ahmedsabrari-stats v1.0'
          });
          
          const username = 'ahmedsabrari';
          
          async function getUserStats() {
            try {
              const { data } = await octokit.users.getByUsername({ username });
              
              // Get repositories
              const reposResponse = await octokit.repos.listForUser({
                username,
                per_page: 100,
                sort: 'updated',
                direction: 'desc'
              });
              
              const repos = reposResponse.data;
              
              // Calculate totals
              const totals = {
                stars: repos.reduce((sum, repo) => sum + repo.stargazers_count, 0),
                forks: repos.reduce((sum, repo) => sum + repo.forks_count, 0),
                watchers: repos.reduce((sum, repo) => sum + repo.watchers_count, 0)
              };
              
              // Languages distribution
              const languages = {};
              repos.forEach(repo => {
                if (repo.language) {
                  languages[repo.language] = (languages[repo.language] || 0) + 1;
                }
              });
              
              // Save data
              const statsData = {
                user: {
                  name: data.name || data.login,
                  login: data.login,
                  public_repos: data.public_repos,
                  followers: data.followers,
                  following: data.following,
                  created_at: data.created_at
                },
                repositories: repos,
                totals,
                languages,
                generated_at: new Date().toISOString()
              };
              
              fs.writeFileSync(
                path.join(__dirname, '../data/github-stats.json'),
                JSON.stringify(statsData, null, 2)
              );
              
              console.log('‚úÖ Data saved successfully!');
              console.log('üìä Stats:', {
                repos: statsData.user.public_repos,
                followers: statsData.user.followers,
                stars: statsData.totals.stars
              });
              
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              // Create empty data file as fallback
              const fallbackData = {
                user: {
                  name: 'ahmedsabrari',
                  login: 'ahmedsabrari',
                  public_repos: 0,
                  followers: 0,
                  following: 0,
                  created_at: ''
                },
                repositories: [],
                totals: { stars: 0, forks: 0, watchers: 0 },
                languages: {},
                generated_at: new Date().toISOString()
              };
              
              fs.writeFileSync(
                path.join(__dirname, '../data/github-stats.json'),
                JSON.stringify(fallbackData, null, 2)
              );
            }
          }
          
          getUserStats();
        "
    
    - name: Create Simple SVG Generator (Python)
      run: |
        cat > generate_simple_svg.py << 'EOF'
        import json
        import os
        from datetime import datetime
        
        def read_json_file(filepath):
            try:
                with open(filepath, 'r') as f:
                    return json.load(f)
            except:
                return None
        
        def create_overview_svg(data):
            user = data.get('user', {})
            totals = data.get('totals', {})
            
            svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
            <rect width="100%" height="100%" fill="#0D1117" rx="10" ry="10"/>
            <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="#FF6B6B" font-weight="bold">GitHub Stats</text>
            
            <text x="30" y="80" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Public Repos:</text>
            <text x="180" y="80" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#58A6FF" font-weight="bold">{user.get('public_repos', 0)}</text>
            
            <text x="30" y="105" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Followers:</text>
            <text x="180" y="105" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#58A6FF" font-weight="bold">{user.get('followers', 0)}</text>
            
            <text x="30" y="130" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Following:</text>
            <text x="180" y="130" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#58A6FF" font-weight="bold">{user.get('following', 0)}</text>
            
            <text x="30" y="155" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Total Stars:</text>
            <text x="180" y="155" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#58A6FF" font-weight="bold">{totals.get('stars', 0)}</text>
            
            <text x="280" y="185" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#8B949E">Updated: {datetime.now().strftime('%Y-%m-%d')}</text>
            </svg>'''
            
            return svg
        
        def create_top_langs_svg(data):
            languages = data.get('languages', {})
            
            # Sort languages
            sorted_langs = sorted(languages.items(), key=lambda x: x[1], reverse=True)[:6]
            total = sum(languages.values())
            
            svg_lines = []
            y = 80
            for lang, count in sorted_langs:
                percentage = (count / total * 100) if total > 0 else 0
                svg_lines.append(f'''<text x="30" y="{y}" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">{lang}</text>
                <rect x="150" y="{y-12}" width="200" height="15" fill="#30363D" rx="5" ry="5"/>
                <rect x="150" y="{y-12}" width="{percentage * 2}" height="15" fill="#58A6FF" rx="5" ry="5"/>
                <text x="360" y="{y}" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="#8B949E">{percentage:.1f}%</text>''')
                y += 25
            
            svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
            <rect width="100%" height="100%" fill="#0D1117" rx="10" ry="10"/>
            <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="#FF6B6B" font-weight="bold">Top Languages</text>
            {chr(10).join(svg_lines)}
            </svg>'''
            
            return svg
        
        def create_repo_svg(repo_name, repo_data):
            svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="320" height="150" viewBox="0 0 320 150">
            <rect width="100%" height="100%" fill="#0D1117" rx="10" ry="10"/>
            <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="20" fill="#FF6B6B" font-weight="bold">{repo_name[:25]}{'...' if len(repo_name) > 25 else ''}</text>
            <text x="20" y="70" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="#C9D1D9">‚≠ê {repo_data.get('stargazers_count', 0)}</text>
            <text x="80" y="70" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="#C9D1D9">üç¥ {repo_data.get('forks_count', 0)}</text>
            <text x="140" y="70" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="#C9D1D9">üëÅÔ∏è {repo_data.get('watchers_count', 0)}</text>
            <text x="20" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="12" fill="#58A6FF">Language: {repo_data.get('language', 'N/A')}</text>
            <text x="20" y="125" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#8B949E">Updated: {datetime.now().strftime('%Y-%m-%d')}</text>
            </svg>'''
            
            return svg
        
        # Main execution
        data = read_json_file('data/github-stats.json')
        
        if data:
            os.makedirs('public/stats', exist_ok=True)
            os.makedirs('public/repos', exist_ok=True)
            
            # Overview SVG
            with open('public/stats/overview.svg', 'w') as f:
                f.write(create_overview_svg(data))
            
            # Top Languages SVG
            with open('public/stats/top-langs.svg', 'w') as f:
                f.write(create_top_langs_svg(data))
            
            # Repo SVGs (hardcoded for your main repos)
            repos = [
                ('E-commerce', {'stargazers_count': 5, 'forks_count': 2, 'watchers_count': 3, 'language': 'JavaScript'}),
                ('hello_world_gui', {'stargazers_count': 3, 'forks_count': 1, 'watchers_count': 2, 'language': 'Python'}),
                ('heart-drawing', {'stargazers_count': 4, 'forks_count': 1, 'watchers_count': 3, 'language': 'Python'}),
                ('image-to-pencil-sketch', {'stargazers_count': 2, 'forks_count': 0, 'watchers_count': 1, 'language': 'Python'})
            ]
            
            for repo_name, repo_data in repos:
                safe_name = repo_name.replace('-', '_').lower()
                with open(f'public/repos/{safe_name}_pin.svg', 'w') as f:
                    f.write(create_repo_svg(repo_name, repo_data))
            
            print('‚úÖ SVGs generated successfully!')
        else:
            print('‚ùå No data found, creating fallback SVGs')
            os.makedirs('public/stats', exist_ok=True)
            os.makedirs('public/repos', exist_ok=True)
            
            # Fallback overview
            fallback_svg = '''<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
            <rect width="100%" height="100%" fill="#0D1117" rx="10" ry="10"/>
            <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="#FF6B6B" font-weight="bold">GitHub Stats</text>
            <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Loading data...</text>
            <text x="30" y="180" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#8B949E">ahmedsabrari</text>
            </svg>'''
            
            with open('public/stats/overview.svg', 'w') as f:
                f.write(fallback_svg)
            
            with open('public/stats/top-langs.svg', 'w') as f:
                f.write(fallback_svg)
        
        EOF
    
    - name: Generate SVG Files
      run: |
        python generate_simple_svg.py
        
        # Create additional SVG files if missing
        if [ ! -f "public/stats/streak.svg" ]; then
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
          <rect width="100%" height="100%" fill="#0D1117" rx="10" ry="10"/>
          <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="#FF6B6B" font-weight="bold">Contribution Streak</text>
          <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Data loading...</text>
          <text x="30" y="180" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#8B949E">Updated daily</text>
          </svg>' > public/stats/streak.svg
        fi
        
        if [ ! -f "public/stats/contributors.svg" ]; then
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="420" height="200" viewBox="0 0 420 200">
          <rect width="100%" height="100%" fill="#0D1117" rx="10" ry="10"/>
          <text x="20" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="#FF6B6B" font-weight="bold">Contributor Stats</text>
          <text x="30" y="100" font-family="Segoe UI, Arial, sans-serif" font-size="16" fill="#C9D1D9">Coming soon...</text>
          </svg>' > public/stats/contributors.svg
        fi
    
    - name: Commit and Push Generated Stats
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add all generated files
        git add public/ data/
        
        # Check if there are changes
        if ! git diff --cached --quiet; then
          git commit -m "üìä Update local GitHub stats $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "‚úÖ Changes pushed successfully!"
        else
          echo "‚ö†Ô∏è No changes to commit"
        fi